# parameters
config=$1
source ${config}

# check the arguments

cat ${config}

# preparation

np=`expr ${client_num_per_round} + 1`
echo "np=${np}"

script_name="autogenerated_method_${method}_npn_${gpupernode}_np_${np}_m_${model}_ds_${dataset}_cn_${client_num}_cnp_${client_num_per_round}".sh
output_dir="output_autogenerated_method_${method}_npn_${gpupernode}_np_${np}_m_${model}_ds_${dataset}_cn_${client_num}_cnp_${client_num_per_round}"
wandb_api_key=`cat ../wandb_api_key.txt`

if [ ${node_type} = "pascal_short.q" ]; then
  npernode=${gpupernode}
else
  npernode=${worker_num_pergpu}
fi

# auto-generate a script

echo -ne "#!/bin/sh
#$ -S /bin/bash
#$ -q ${node_type}
#$ -pe mpi $((24*(($np/($gpupernode*$worker_num_pergpu))+($np%($gpupernode*$worker_num_pergpu)))))

module load compiler/gcc/7
module load mpi/openmpi/3.0.0

# function cleanup_exit() {
#  hostname
#  pkill FedAvg
# }

# trap cleanup_exit SIGUSR2

set -ex

# code checking
# pyflakes .

wandb login ${wandb_api_key} --relogin
wandb online

cd ../../src/distributed

python3 gpu_mapping_yaml_generator.py --client_num_per_round $client_num_per_round --worker_num_pergpu $worker_num_pergpu --gpupernode $gpupernode

hostname > mpi_host_file

if [ ! -e ${output_dir} ]; then
  mkdir ${output_dir}
fi

mpirun -np ${np} -npernode ${npernode} python3 ${py_file} \\
  --gpu_mapping_file ${gpu_mapping_yaml} \\
  --gpu_mapping_key mapping_config_client_num_per_round_${client_num_per_round}_worker_num_pergpu_${worker_num_pergpu}_gpupernode_${gpupernode} \\
  --model ${model} \\
  --dataset ${dataset} \\
  --data_dir ${data_dir} \\
  --partition_method ${partition_method} \\
  --partition_alpha ${partition_alpha} \\
  --client_num_in_total ${client_num} \\
  --client_num_per_round ${client_num_per_round} \\
  --comm_round ${comm_round} \\
  --epochs ${epochs} \\
  --client_optimizer ${client_optimizer} \\
  --batch_size ${batch_size} \\
  --lr ${lr} \\
  --clip_grad ${clip_grad} \\
  --max_norm ${max_norm} \\
  --ci ${ci} \\
  --method ${method} \\
  --output_dir ${output_dir} \\
  --autoencoder_lr ${autoencoder_lr} \\
  --autoencoder_epochs ${autoencoder_epochs} \\
  --autoencoder_type ${autoencoder_type} \\
  --warm_up ${warm_up} \\
  --alpha ${alpha} \\
  --sparcity ${sparcity} \\
  --remove ${remove} \\
  --k ${k} \\
  --inv ${inv} \\
  --indicative_features ${indicative_features} \\
  --adversary_num ${adversary_num} \\
  --adversary_type ${adversary_type} \\
  --ignore_adversary ${ignore_adversary} \\
  --free_rider_strategy ${free_rider_strategy} \\
  --noise_amp ${noise_amp} \\
  --water_powered_magnification ${water_powered_magnification} \\
  --inflator_data_size ${inflator_data_size} \\
  --inflator_batch_size ${inflator_batch_size} \\
  --inflator_strategy ${inflator_strategy} \\
  --multiple_accounts_split ${multiple_accounts_split} \\
  --poor_adversary ${poor_adversary} \\
  --num_of_augmentation ${num_of_augmentation} \\
  --frequency_of_the_test ${frequency_of_the_test}
  
mpirun -np ${np} -npernode ${npernode} ps aux | grep FedAvg" > $script_name

# submit the auto-generated script
if [ $submit_script -eq 1 ] ; then
  qsub -notify $script_name
fi